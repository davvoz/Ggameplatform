<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Platform - Authentication</title>
    <link rel="stylesheet" href="./css/variables.css">
    <link rel="stylesheet" href="./css/layout.css">
    <link rel="stylesheet" href="./css/auth.css">
</head>
<body>
    <main class="container">
        <div class="auth-container">
            <div class="auth-header">
                <div class="logo">üéÆ</div>
                <h1>Game Platform</h1>
                <p class="auth-subtitle">Choose your login method to start playing</p>
            </div>
            
            <div class="auth-cards">
                <!-- Steem Keychain Auth -->
                <div class="auth-card featured">
                    <div class="card-badge">‚≠ê Recommended</div>
                    <div class="card-icon">üîê</div>
                    <h2 class="card-title">Steem Keychain</h2>
                    <p class="card-description">Authenticate with blockchain and unlock maximum rewards</p>
                    
                    <div class="benefits-compact">
                        <div class="benefit-item">‚ú® 2.0x CUR8 Multiplier</div>
                        <div class="benefit-item">üîó Blockchain Identity</div>
                        <div class="benefit-item">üíæ Progress Saved</div>
                        <div class="benefit-item">üèÜ Tournaments</div>
                    </div>
                    
                    <button class="btn-auth btn-auth-primary" onclick="loginWithSteem()">
                        <span class="btn-icon">üîë</span>
                        <span>Sign with Keychain</span>
                    </button>
                    
                    <div id="steemStatus" class="auth-status"></div>
                </div>
                
                <!-- Anonymous Auth -->
                <div class="auth-card">
                    <div class="card-icon">üë§</div>
                    <h2 class="card-title">Play Anonymous</h2>
                    <p class="card-description">Start playing instantly without registration</p>
                    
                    <div class="benefits-compact">
                        <div class="benefit-item">‚ö° Instant Access</div>
                        <div class="benefit-item">üîí Complete Privacy</div>
                        <div class="benefit-item">üéÆ No Registration</div>
                        <div class="benefit-item">üß™ Quick Testing</div>
                    </div>
                    
                    <button class="btn-auth btn-auth-secondary" onclick="playAnonymous()">
                        <span class="btn-icon">üöÄ</span>
                        <span>Play Now</span>
                    </button>
                    
                    <div id="anonStatus" class="auth-status"></div>
                </div>
            </div>
            
 
        </div>
    </main>
    
    <script>
        const API_BASE = 'http://localhost:8000/users';
        
        // Check if Steem Keychain is installed
        function checkSteemKeychain() {
            if (typeof window.steem_keychain === 'undefined') {
                return false;
            }
            return true;
        }
        
        // Login with Steem Keychain
        async function loginWithSteem() {
            const statusEl = document.getElementById('steemStatus');
            
            if (!checkSteemKeychain()) {
                    statusEl.className = 'auth-status error';
                    statusEl.innerHTML = '‚ùå SteemKeychain non rilevato! <br><small>Installa l\'estensione da <a href="https://chrome.google.com/webstore/detail/steem-keychain/lkcjlnjfpbikmcmbachjpdbijejflpcm" target="_blank">Chrome Web Store</a></small>';
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'auth-status info';
            statusEl.innerHTML = '<span class="auth-loading"></span>Richiesta username...';
            statusEl.style.display = 'block';
            
            // Request username
            const username = prompt('Inserisci il tuo username Steem:');
            if (!username) {
                statusEl.style.display = 'none';
                return;
            }
            
            // Create message to sign (username + timestamp)
            const timestamp = Math.floor(Date.now() / 1000);
            const message = `${username}|${timestamp}`;
            
            statusEl.innerHTML = '<span class="auth-loading"></span>Attendi firma da Keychain...';
            
            // Request signature from Keychain
            window.steem_keychain.requestSignBuffer(
                username,
                message,
                'Posting',
                async function(response) {
                    if (response.success) {
                        try {
                            // Send to backend for verification
                            statusEl.innerHTML = '<span class="auth-loading"></span>Verifica firma in corso...';
                            
                            const authResponse = await fetch(`${API_BASE}/steem-auth`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: username,
                                    signature: response.result,
                                    message: message,
                                    cur8_multiplier: 2.0
                                })
                            });
                            
                            const data = await authResponse.json();
                            
                            if (authResponse.ok) {
                                statusEl.className = 'auth-status success';
                                statusEl.innerHTML = `‚úì ${data.message}<br><small>Moltiplicatore: ${data.user.cur8_multiplier}x | XP Totale: ${data.user.total_xp_earned}</small>`;
                                
                                // Save user to localStorage
                                localStorage.setItem('currentUser', JSON.stringify(data.user));
                                localStorage.setItem('authMethod', 'steem_keychain');
                                
                                // Redirect to game platform after 2 seconds
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 2000);
                            } else {
                                throw new Error(data.detail || 'Authentication failed');
                            }
                            
                        } catch (error) {
                            statusEl.className = 'auth-status error';
                            statusEl.innerHTML = `‚ùå Errore: ${error.message}`;
                        }
                    } else {
                        statusEl.className = 'auth-status error';
                        statusEl.innerHTML = '‚ùå Firma rifiutata o fallita';
                    }
                }
            );
        }
        
        // Play Anonymous
        async function playAnonymous() {
            const statusEl = document.getElementById('anonStatus');
            
            statusEl.className = 'auth-status info';
            statusEl.innerHTML = '<span class="auth-loading"></span>Creazione utente anonimo...';
            statusEl.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/anonymous`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cur8_multiplier: 1.0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusEl.className = 'auth-status success';
                    statusEl.innerHTML = `‚úì ${data.message}<br><small>ID: ${data.user.user_id}</small>`;
                    
                    // Save user to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    localStorage.setItem('authMethod', 'anonymous');
                    
                    // Redirect to game platform after 1 second
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    throw new Error(data.detail || 'Failed to create anonymous user');
                }
                
            } catch (error) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = `‚ùå Errore: ${error.message}`;
            }
        }
        
        // Check if user is already logged in
        window.addEventListener('load', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                if (confirm(`Sei gi√† autenticato come ${user.username || user.user_id}. Vuoi continuare?`)) {
                    window.location.href = '/';
                } else {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('authMethod');
                }
            }
        });
    </script>
</body>
</html>
