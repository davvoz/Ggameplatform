<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Platform - Authentication</title>
    <link rel="stylesheet" href="./css/variables.css">
    <link rel="stylesheet" href="./css/layout.css">
    <link rel="stylesheet" href="./css/auth.css">
</head>
<body>
    <main class="container">
        <div class="auth-container">
            <!-- Hero Section -->
            <div class="hero-section">
                <img src="./icons/icon-192x192.png" alt="Cur8 Games Logo" class="hero-logo">
                <h1 class="hero-title">Cur8 Games</h1>
                <p class="hero-subtitle">Play. Earn. Compete.</p>
                <div class="hero-stats">
                    <div class="stat-pill">
                        <span class="stat-icon">üèÜ</span>
                        <span>Weekly Prizes</span>
                    </div>
                    <div class="stat-pill">
                        <span class="stat-icon">üí∞</span>
                        <span>Real Rewards</span>
                    </div>
                </div>
            </div>

            <div class="auth-card-unified">
                <!-- Method Switcher -->
                <div class="method-switcher">
                    <button class="method-tab active" data-method="keychain" onclick="switchAuthMethod('keychain')">
                        <span>üîê</span> Keychain
                    </button>
                    <button class="method-tab" data-method="postingkey" onclick="switchAuthMethod('postingkey')">
                        <span>üîë</span> Posting Key
                    </button>
                    <button class="method-tab" data-method="anonymous" onclick="switchAuthMethod('anonymous')">
                        <span>üë§</span> Anonymous
                    </button>
                </div>

                <!-- Keychain Method -->
                <div class="auth-method-content active" id="keychain-content">
                    <div class="method-description">
                        <h3>üîê Steem Keychain</h3>
                        <p>Authenticate securely via browser extension</p>
                    </div>
                    
                    <div class="auth-form-inline">
                        <div class="form-group-compact">
                            <input type="text" id="keychainUsername" placeholder="Steem username" />
                        </div>
                    </div>
                    
                    <button class="btn-auth btn-auth-primary" onclick="loginWithSteem()">
                        <span class="btn-icon">üîë</span>
                        <span>Sign with Keychain</span>
                    </button>
                    
                    <div id="steemStatus" class="auth-status"></div>
                </div>

                <!-- Posting Key Method -->
                <div class="auth-method-content" id="postingkey-content">
                    <div class="method-description">
                        <h3>üîë Posting Key Login</h3>
                        <p>Login with your Steem username and posting key</p>
                    </div>
                    
                    <form id="postingKeyForm" method="post" action="javascript:void(0);" autocomplete="on" onsubmit="return handlePostingKeySubmit(event)">
                        <div class="auth-form-inline">
                            <div class="form-group-compact">
                                <label for="postingKeyUsername" style="display:none;">Username</label>
                                <input type="text" id="postingKeyUsername" name="username" autocomplete="username webauthn" placeholder="Steem username" />
                            </div>
                            <div class="form-group-compact">
                                <label for="postingKey" style="display:none;">Password</label>
                                <input type="password" id="postingKey" name="password" autocomplete="current-password webauthn" placeholder="Posting key" />
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-auth btn-auth-primary">
                            <span class="btn-icon">üîì</span>
                            <span>Login with Key</span>
                        </button>
                    </form>
                    
                    <div id="postingKeyStatus" class="auth-status"></div>
                </div>

                <!-- Anonymous Method -->
                <div class="auth-method-content" id="anonymous-content">
                    <div class="method-description">
                        <h3>üë§ Play Anonymous</h3>
                        <p>Start playing without a Steem account (No Rewards)</p>
                    </div>
                    
                    <button class="btn-auth btn-auth-primary" onclick="playAnonymous()">
                        <span class="btn-icon">üöÄ</span>
                        <span>Play Now</span>
                    </button>
                    
                    <div id="anonStatus" class="auth-status"></div>
                </div>
            </div>
            
 
        </div>
    </main>
    
    <!-- Load environment config first -->
    <script src="/env.js"></script>
    
    <script>
        // Get API URL from window.ENV
        const API_BASE = `${window.ENV?.API_URL || 'http://localhost:8000'}/users`;
        
        // Switch authentication method
        function switchAuthMethod(method) {
            // Update tabs
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.auth-method-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${method}-content`).classList.add('active');
        }
        
        // Check if Steem Keychain is installed
        function checkSteemKeychain() {
            if (typeof window.steem_keychain === 'undefined') {
                return false;
            }
            return true;
        }
        
        // Login with Steem Keychain
        async function loginWithSteem() {
            const statusEl = document.getElementById('steemStatus');
            const usernameInput = document.getElementById('keychainUsername');
            
            if (!checkSteemKeychain()) {
                    statusEl.className = 'auth-status error';
                    statusEl.innerHTML = '‚ùå SteemKeychain not detected! <br><small>Install the extension from <a href="https://chrome.google.com/webstore/detail/steem-keychain/lkcjlnjfpbikmcmbachjpdbijejflpcm" target="_blank">Chrome Web Store</a></small>';
                statusEl.style.display = 'block';
                return;
            }
            
            const username = usernameInput.value.trim().toLowerCase();
            
            if (!username) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = '‚ùå Enter your Steem username';
                statusEl.style.display = 'block';
                usernameInput.focus();
                return;
            }
            
            statusEl.className = 'auth-status info';
            statusEl.innerHTML = '<span class="auth-loading"></span>Waiting for Keychain signature...';
            statusEl.style.display = 'block';
            
            // Create message to sign (username + timestamp)
            const timestamp = Math.floor(Date.now() / 1000);
            const message = `${username}|${timestamp}`;
            
            statusEl.innerHTML = '<span class="auth-loading"></span>Waiting for Keychain signature...';
            
            // Request signature from Keychain
            window.steem_keychain.requestSignBuffer(
                username,
                message,
                'Posting',
                async function(response) {
                    if (response.success) {
                        try {
                            // Send to backend for verification
                            statusEl.innerHTML = '<span class="auth-loading"></span>Verifying signature...';
                            
                            const authResponse = await fetch(`${API_BASE}/steem-auth`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: username,
                                    signature: response.result,
                                    message: message,
                                    cur8_multiplier: 1.0
                                })
                            });
                            
                            const data = await authResponse.json();
                            
                            if (authResponse.ok) {
                                statusEl.className = 'auth-status success';
                                statusEl.innerHTML = `‚úì ${data.message}<br><small>Multiplier: ${data.user.cur8_multiplier}x | Total XP: ${data.user.total_xp_earned}</small>`;
                                
                                // Save user to localStorage
                                localStorage.setItem('currentUser', JSON.stringify(data.user));
                                localStorage.setItem('authMethod', 'steem_keychain');
                                
                                // Redirect to game platform after 2 seconds
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 2000);
                            } else {
                                throw new Error(data.detail || 'Authentication failed');
                            }
                            
                        } catch (error) {
                            statusEl.className = 'auth-status error';
                            statusEl.innerHTML = `‚ùå Error: ${error.message}`;
                        }
                    } else {
                        statusEl.className = 'auth-status error';
                        statusEl.innerHTML = '‚ùå Signature rejected or failed';
                    }
                }
            );
        }
        
        // Login with Posting Key
        function handlePostingKeySubmit(event) {
            event.preventDefault();
            loginWithPostingKey();
            return false;
        }
        
        async function loginWithPostingKey() {
            const statusEl = document.getElementById('postingKeyStatus');
            const usernameInput = document.getElementById('postingKeyUsername');
            const postingKeyInput = document.getElementById('postingKey');
            
            const username = usernameInput.value.trim().toLowerCase();
            const postingKey = postingKeyInput.value.trim();
            
            // Validate inputs
            if (!username) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = '‚ùå Enter your Steem username';
                statusEl.style.display = 'block';
                usernameInput.focus();
                return;
            }
            
            if (!postingKey) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = '‚ùå Enter your posting key';
                statusEl.style.display = 'block';
                postingKeyInput.focus();
                return;
            }
            
            // Basic key format validation
            if (postingKey.length < 50 || !postingKey.startsWith('5')) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = '‚ùå Invalid posting key format. Steem keys start with "5" and are approximately 51 characters long';
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'auth-status info';
            statusEl.innerHTML = '<span class="auth-loading"></span>Verifying posting key...';
            statusEl.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/steem-posting-key-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        posting_key: postingKey,
                        cur8_multiplier: 1.0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusEl.className = 'auth-status success';
                    statusEl.innerHTML = `‚úì ${data.message}<br><small>Multiplier: ${data.user.cur8_multiplier}x | Total XP: ${data.user.total_xp_earned}</small>`;
                    
                    // Clear the posting key from the input (security)
                    postingKeyInput.value = '';
                    
                    // Save user to localStorage (NOT the posting key!)
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    localStorage.setItem('authMethod', 'steem_posting_key');
                    
                    // Redirect to game platform after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    throw new Error(data.detail || 'Authentication failed');
                }
                
            } catch (error) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        // Play Anonymous
        async function playAnonymous() {
            const statusEl = document.getElementById('anonStatus');
            
            statusEl.className = 'auth-status info';
            statusEl.innerHTML = '<span class="auth-loading"></span>Creating anonymous user...';
            statusEl.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/anonymous`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cur8_multiplier: 1.0
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusEl.className = 'auth-status success';
                    statusEl.innerHTML = `‚úì ${data.message}<br><small>ID: ${data.user.user_id}</small>`;
                    
                    // Save user to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    localStorage.setItem('authMethod', 'anonymous');
                    
                    // Redirect to game platform after 1 second
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    throw new Error(data.detail || 'Failed to create anonymous user');
                }
                
            } catch (error) {
                statusEl.className = 'auth-status error';
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        // Switch authentication method
        function switchAuthMethod(method) {
            // Update tabs
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.auth-method-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${method}-content`).classList.add('active');
        }

        // Show platform reset message if needed
        function showPlatformResetMessage() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reason') === 'platform_reset') {
                // Create notification banner
                const banner = document.createElement('div');
                banner.className = 'platform-reset-banner';
                banner.innerHTML = `
                    <div class="reset-message">
                        <span class="reset-icon">üîÑ</span>
                        <span>The platform has been reset. Please login again.</span>
                        <button class="reset-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                    </div>
                `;
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    z-index: 9999;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                banner.querySelector('.reset-message').style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    font-weight: 500;
                `;
                banner.querySelector('.reset-close').style.cssText = `
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: 15px;
                `;
                document.body.prepend(banner);
                
                // Remove the query parameter from URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Check if user is already logged in
        window.addEventListener('load', () => {
            // Show platform reset message if present
            showPlatformResetMessage();
            
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                if (confirm(`You are already authenticated as ${user.username || user.user_id}. Continue?`)) {
                    window.location.href = '/';
                } else {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('authMethod');
                }
            }
        });
    </script>
</body>
</html>
