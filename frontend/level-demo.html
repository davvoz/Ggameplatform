<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level System Demo - Game Platform</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/level-widget.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #6366f1;
            margin-bottom: 32px;
        }

        .demo-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .demo-section h2 {
            color: #374151;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        button.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            width: 150px;
        }

        label {
            font-weight: 600;
            color: #374151;
        }

        .info-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .info-box h3 {
            margin: 0 0 8px;
            color: #1e40af;
            font-size: 16px;
        }

        .info-box p {
            margin: 4px 0;
            color: #1e3a8a;
            font-size: 14px;
        }

        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .milestone-card {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid;
            background: white;
        }

        .milestone-badge {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .milestone-level {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .milestone-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .milestone-xp {
            font-size: 12px;
            color: #6b7280;
        }

        #user-info {
            margin-bottom: 24px;
            padding: 16px;
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 8px;
        }

        #user-info.no-user {
            background: #fef2f2;
            border-color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Level System Demo</h1>

        <div id="user-info" class="no-user">
            <p><strong>Status:</strong> Non autenticato - Effettua il login per testare il sistema livelli</p>
            <button onclick="window.location.href='/auth.html'">Vai al Login</button>
        </div>

        <div class="demo-section">
            <h2>üìä Il Tuo Livello</h2>
            <div id="level-widget-container"></div>
            <div class="info-box" id="level-info">
                <h3>Informazioni Livello</h3>
                <p>Caricamento...</p>
            </div>
        </div>

        <div class="demo-section">
            <h2>üéØ Simula Guadagno XP</h2>
            <p>Simula sessioni di gioco per guadagnare XP e vedere i level-up in azione:</p>
            <div class="input-group">
                <label for="xp-amount">XP da aggiungere:</label>
                <input type="number" id="xp-amount" value="50" min="1" max="10000">
                <button onclick="simulateXPGain()">Aggiungi XP</button>
            </div>
            <div class="button-group">
                <button class="secondary" onclick="simulateXPGain(100)">+100 XP</button>
                <button class="secondary" onclick="simulateXPGain(500)">+500 XP</button>
                <button class="secondary" onclick="simulateXPGain(1000)">+1000 XP</button>
            </div>
        </div>

        <div class="demo-section">
            <h2>üèÜ Traguardi (Milestones)</h2>
            <p>I livelli con badge speciali e ricompense:</p>
            <div id="milestones-container" class="milestones-grid"></div>
        </div>

        <div class="demo-section">
            <h2>üìà Classifica Livelli</h2>
            <div id="leaderboard-container"></div>
            <button onclick="loadLeaderboard()">Aggiorna Classifica</button>
        </div>

        <div class="demo-section">
            <h2>üßÆ Calcola Livello da XP</h2>
            <div class="input-group">
                <label for="calc-xp">XP:</label>
                <input type="number" id="calc-xp" value="1000" min="0">
                <button onclick="calculateLevel()">Calcola Livello</button>
            </div>
            <div id="calc-result" class="info-box" style="display:none; margin-top: 12px;">
                <h3>Risultato</h3>
                <p id="calc-result-text"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import LevelWidget from '/js/level-widget.js';
        
        let levelWidget = null;
        let currentUser = null;

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                document.getElementById('user-info').classList.add('no-user');
                return null;
            }

            try {
                const response = await fetch(`${window.config.API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    document.getElementById('user-info').innerHTML = `
                        <p><strong>Utente:</strong> ${user.username}</p>
                        <p><strong>XP Totale:</strong> ${user.total_xp_earned.toFixed(2)}</p>
                    `;
                    document.getElementById('user-info').classList.remove('no-user');
                    return user;
                } else {
                    localStorage.removeItem('auth_token');
                    return null;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                return null;
            }
        }

        // Initialize
        async function init() {
            const user = await checkAuth();
            
            if (user) {
                // Initialize level widget
                levelWidget = new LevelWidget();
                await levelWidget.init(user.user_id);
                
                const container = document.getElementById('level-widget-container');
                levelWidget.setContainer(container);

                // Load level info
                await loadLevelInfo(user.user_id);

                // Load milestones
                await loadMilestones();

                // Load leaderboard
                await loadLeaderboard();
            }
        }

        async function loadLevelInfo(userId) {
            try {
                const response = await fetch(`${window.config.API_URL}/levels/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('level-info').innerHTML = `
                        <h3>Dettagli Progressione</h3>
                        <p><strong>Livello Attuale:</strong> ${data.current_level}</p>
                        <p><strong>Titolo:</strong> ${data.badge} ${data.title}</p>
                        <p><strong>XP Attuale:</strong> ${data.current_xp.toFixed(2)}</p>
                        <p><strong>XP per Prossimo Livello:</strong> ${data.xp_needed_for_next > 0 ? data.xp_needed_for_next.toFixed(0) : 'Livello massimo!'}</p>
                        <p><strong>Progresso:</strong> ${data.progress_percent.toFixed(1)}%</p>
                    `;
                }
            } catch (error) {
                console.error('Failed to load level info:', error);
            }
        }

        async function loadMilestones() {
            try {
                const response = await fetch(`${window.config.API_URL}/levels/milestones/all`);
                if (response.ok) {
                    const milestones = await response.json();
                    const container = document.getElementById('milestones-container');
                    
                    container.innerHTML = milestones.map(m => `
                        <div class="milestone-card" style="border-color: ${m.color}">
                            <div class="milestone-badge">${m.badge}</div>
                            <div class="milestone-level" style="color: ${m.color}">Livello ${m.level}</div>
                            <div class="milestone-title" style="color: ${m.color}">${m.title}</div>
                            <div class="milestone-xp">${m.xp_required.toFixed(0)} XP richiesti</div>
                            ${m.coins_reward ? `<div style="margin-top: 8px; font-weight: bold;">ü™ô ${m.coins_reward} Coins</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load milestones:', error);
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${window.config.API_URL}/levels/leaderboard/top-levels?limit=10`);
                if (response.ok) {
                    const leaderboard = await response.json();
                    const container = document.getElementById('leaderboard-container');
                    
                    if (leaderboard.length === 0) {
                        container.innerHTML = '<p>Nessun giocatore in classifica</p>';
                        return;
                    }

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">#</th>
                                    <th style="padding: 12px; text-align: left;">Giocatore</th>
                                    <th style="padding: 12px; text-align: center;">Livello</th>
                                    <th style="padding: 12px; text-align: center;">Titolo</th>
                                    <th style="padding: 12px; text-align: right;">XP Totale</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderboard.map((player, idx) => `
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 12px; font-weight: bold; color: ${idx < 3 ? '#f59e0b' : '#6b7280'};">${idx + 1}</td>
                                        <td style="padding: 12px; font-weight: 600;">${player.username}</td>
                                        <td style="padding: 12px; text-align: center; font-size: 20px;">${player.badge}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span style="background: ${player.color}15; color: ${player.color}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                Lv ${player.level} ${player.title}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: right; font-weight: 600;">${player.total_xp.toFixed(0)} XP</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }

        window.simulateXPGain = async function(amount) {
            if (!currentUser) {
                alert('Devi effettuare il login per testare questa funzione');
                return;
            }

            const xpAmount = amount || parseInt(document.getElementById('xp-amount').value);
            if (!xpAmount || xpAmount <= 0) return;

            // Update user XP (simulate via manual update endpoint - you'd need to create this)
            // For now, we'll just show a mock level-up
            const oldXp = currentUser.total_xp_earned;
            const newXp = oldXp + xpAmount;

            // Check if we leveled up
            const oldLevelResp = await fetch(`${window.config.API_URL}/levels/calculate/xp-to-level/${oldXp}`);
            const oldLevelData = await oldLevelResp.json();
            
            const newLevelResp = await fetch(`${window.config.API_URL}/levels/calculate/xp-to-level/${newXp}`);
            const newLevelData = await newLevelResp.json();

            if (newLevelData.level > oldLevelData.level) {
                // Show level-up notification
                if (levelWidget) {
                    levelWidget.showLevelUpNotification({
                        old_level: oldLevelData.level,
                        new_level: newLevelData.level,
                        title: newLevelData.title,
                        badge: newLevelData.badge,
                        coins_awarded: newLevelData.coins_reward || 0,
                        is_milestone: newLevelData.is_milestone
                    });
                }
            }

            // Simulate XP gain notification
            const notification = document.createElement('div');
            notification.className = 'xp-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
                z-index: 10000;
                animation: slideIn 0.5s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px;">‚≠ê</span>
                    <span style="font-size: 18px; font-weight: bold; color: #1a1a1a;">+${xpAmount} XP</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);

            alert(`Simulato guadagno di ${xpAmount} XP! In produzione, questo accadrebbe automaticamente dopo ogni sessione di gioco.`);
        };

        window.calculateLevel = async function() {
            const xp = parseFloat(document.getElementById('calc-xp').value);
            if (xp < 0) return;

            try {
                const response = await fetch(`${window.config.API_URL}/levels/calculate/xp-to-level/${xp}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('calc-result-text').innerHTML = `
                        Con <strong>${xp} XP</strong> sei al <strong>Livello ${data.level}</strong><br>
                        Titolo: ${data.badge} <strong>${data.title}</strong><br>
                        ${data.is_milestone ? '‚ú® <strong>Questo √® un traguardo milestone!</strong>' : ''}
                    `;
                    document.getElementById('calc-result').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to calculate level:', error);
            }
        };

        window.loadLeaderboard = loadLeaderboard;

        // Initialize on load
        init();
    </script>
</body>
</html>
